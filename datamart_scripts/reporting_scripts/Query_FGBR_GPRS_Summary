insert into uk_rrbs_rt.fgbr_gprs_summary
(select
		'FGBR' as sitecode
		, 'PAYG_DATA' as cat
		, Data_connection_dt as dd
		, Bundle_code
		, msisdn
		,drdct.cdrtype_val as CRD_Type
		,drdc.code_param_val as Roaming_Val
		,drds.subscribertype_val
		, COUNT(*) as cnts
		, SUM(CAST(Total_Used_Bytes as float))/1048576. as data_mb
		, SUM(CAST(Chargeable_Used_Bytes as float))/1048576. as Chargeable_data_mb
		, SUM(CAST(uploaded_bytes as float))/1048576. as uploaded_data_mb
		, SUM(CAST(downloaded_bytes as float))/1048576. as downloaded_data_mb
		, SUM(Data_charge) as chg		
from uk_rrbs_dm.fact_rrbs_gprs
left JOIN uk_rrbs_dm.dim_rrbs_data_codetext drdc
	on drdc.code_param = 'roam_flag'
		and drdc.code_param_id = roam_flag
left JOIN uk_rrbs_dm.dim_rrbs_data_subscribertype drds
	on drds.subscribertype_id = subscriber_type
left JOIN uk_rrbs_dm.dim_rrbs_data_cdrtype drdct
	on drdct.cdrtype_id = cdr_type
where 	Data_connection_dt between '20190901' and '20190930'
		 and cast(Intial_Free_units as float)=0
			and (len(Bundle_code)<2 or Bundle_code is null)
			and Total_Used_Bytes>0
			and Data_charge>0
group by Data_connection_dt
		,msisdn
		,Bundle_code
		,drdc.code_param_val
		,drds.subscribertype_val
		,drdct.cdrtype_val
union
select
		'FGBR' as sitecode
		, 'BUNDLE_DATA' as cat
		, Data_connection_dt as dd
		, Bundle_code
		, msisdn
		,drdct.cdrtype_val as CRD_Type
		,drdc.code_param_val as Roaming_Val
		,drds.subscribertype_val
		, COUNT(*) as cnts
		, SUM(CAST(Total_Used_Bytes as float))/1048576. as data_mb
		, SUM(CAST(Chargeable_Used_Bytes as float))/1048576. as Chargeable_data_mb
		, SUM(CAST(uploaded_bytes as float))/1048576. as uploaded_data_mb
		, SUM(CAST(downloaded_bytes as float))/1048576. as downloaded_data_mb
		, SUM(Data_charge) as chg		
from uk_rrbs_dm.fact_rrbs_gprs
left JOIN uk_rrbs_dm.dim_rrbs_data_codetext drdc
	on drdc.code_param = 'roam_flag'
		and drdc.code_param_id = roam_flag
left JOIN uk_rrbs_dm.dim_rrbs_data_subscribertype drds
	on drds.subscribertype_id = subscriber_type
left JOIN uk_rrbs_dm.dim_rrbs_data_cdrtype drdct
	on drdct.cdrtype_id = cdr_type
where 	Data_connection_dt between '20190901' and '20190930'
		 and cast(Intial_Free_units as float)>0
		and len(Bundle_code)>2
		and Total_Used_Bytes>0
		and Data_charge=0
group by Data_connection_dt
		,msisdn
		,Bundle_code
		,drdc.code_param_val
		,drds.subscribertype_val
		,drdct.cdrtype_val
union
select
		'FGBR' as sitecode
		, 'FREE_DATA' as cat
		, Data_connection_dt as dd
		, Bundle_code
		, msisdn
		,drdct.cdrtype_val as CRD_Type
		,drdc.code_param_val as Roaming_Val
		,drds.subscribertype_val
		, COUNT(*) as cnts
		, SUM(CAST(Total_Used_Bytes as float))/1048576. as data_mb
		, SUM(CAST(Chargeable_Used_Bytes as float))/1048576. as Chargeable_data_mb
		, SUM(CAST(uploaded_bytes as float))/1048576. as uploaded_data_mb
		, SUM(CAST(downloaded_bytes as float))/1048576. as downloaded_data_mb
		, SUM(Data_charge) as chg		
from uk_rrbs_dm.fact_rrbs_gprs
left JOIN uk_rrbs_dm.dim_rrbs_data_codetext drdc
	on drdc.code_param = 'roam_flag'
		and drdc.code_param_id = roam_flag
left JOIN uk_rrbs_dm.dim_rrbs_data_subscribertype drds
	on drds.subscribertype_id = subscriber_type
left JOIN uk_rrbs_dm.dim_rrbs_data_cdrtype drdct
	on drdct.cdrtype_id = cdr_type
where 	Data_connection_dt between '20190901' and '20190930'
		 and cast(Intial_Free_units as float)>0
			and len(Bundle_code)<2
			and Total_Used_Bytes>0
			and Data_charge=0
group by Data_connection_dt
		,msisdn
		,Bundle_code
		,drdc.code_param_val
		,drds.subscribertype_val
		,drdct.cdrtype_val)
